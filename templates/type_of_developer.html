<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>Type of Developer</title>
  </head>
  <body>
    <header>
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-light bg-white">
          <div class="container-fluid">
            <button
                    class="navbar-toggler"
                    type="button"
                    data-mdb-toggle="collapse"
                    data-mdb-target="#navbarExample01"
                    aria-controls="navbarExample01"
                    aria-expanded="false"
                    aria-label="Toggle navigation"
            >
              <i class="fas fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarExample01">
              <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item active">
                  <a class="nav-link" aria-current="page" href="../">Home</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="">Type of developer</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../top-developers-for-a-repo">Top developers for a repo</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../drop_developer_database">Drop developer database</a>
                </li>
              </ul>
            </div>
          </div>
        </nav>
        <!-- Navbar -->
      </header>
      <ul class="list-group">
        <li class="list-group-item">Click "start computation" and wait before it is completed.</li>
        <li class="list-group-item">Click "show visualization" to see the result.</li>
        <li class="list-group-item">If your github token is personal, you may sometimes exceed the API rate. Please wait for a few minutes in this case.</li>
        <li class="list-group-item">The results are cached in the database, so you do not have to rerun the computation, if it was already completed. </li>
        <li class="list-group-item">If something goes wrong, navigate to "Drop developer database" page to reset.</li>
        <li class="list-group-item">You may start computation for multiple users, the progress will be shown for both of them, but the progress messages will be alternating between the different computations.</li>
      </ul>
      <br/>
      <div class="w-50 mx-auto offset-md-2">
        <script>
          function ask_compute(){
            function check_progress(task_id) {

              console.log("Check progress called");
              function worker() {
                console.log("Worker called");
                $.get('progress/' + task_id, function(data) {
                      console.log("Progress data received");
                      document.getElementById("progress_of_task").innerHTML = data;
                      if (data.substring(0,9) !=="Completed" && data.substring(0,6) !=="Failed") {
                        console.log(data);
                        setTimeout(worker, 1000);
                      }
                });
              }
              setTimeout(worker, 1000);
            };

            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                  if (this.readyState == 4 && this.status == 200) {
                    console.log(this.responseText);
                    document.getElementById("your_task_id").innerHTML =
                    "Your computation id is: " + this.responseText;
                    check_progress(this.responseText);
                  }
            };
            xhttp.open("GET", "compute_data/" + document.getElementById("handle").value, true);
            xhttp.send();
          };
 
        </script>

        <script>
          function show_visualization(){
            window.open("type-of-developer/" + document.getElementById("handle").value, '_blank').focus();
          };
        </script>
          <div class="form-group">
            <input type="text" name = "handle" class="form-control" id="handle" placeholder="Enter user's github handle">
          </div>
          <button type="button" id="start_computation" onclick="ask_compute()" class="btn btn-primary mt-3">Start computation for the user</button>
          <button type="button" id="show_visualization" onclick="show_visualization()" class="btn btn-primary mt-3">Show visualization for the user</button>
          <br/>
          <p class="text-center fw-bold" id="your_task_id">You will see the most recent computation task id here.</p>
          <p class="text-center fw-bold" id="progress_of_task">You will see the progress messages here.</p>
      </div>

   

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

  </body>
</html>